name: On Release Collect Changelogs

on:
  release

permissions:
  contents: read

jobs:
  collect-changelogs:
      runs-on: ubuntu-latest
      steps:
        - name: Checkout
          uses: actions/checkout@v4
        - name: Collect Changelogs
          run: |
            echo "Collecting changelogs for release ${{ github.event.release.tag_name }}"
            git log --pretty=format:"%h - %s (%an)" ${{ github.event.release.tag_name}}..HEAD > changelogs.txt
            cat changelogs.txt

  commit-since-last-release:
    runs-on: ubuntu-latest
    steps:
      - name: Run jq
        uses: sergeysova/jq-action@v2
      - name: ğŸ“ Checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - name: ğŸ“‹ Get Commits since last Release
        id: changes
        uses: simbo/changes-since-last-release-action@v1.0.1
      - name: ğŸ“ Output collected Data
        run: |
          echo "Changes since ${{ steps.changes.outputs.last-tag }}:"
          echo "${{ steps.changes.outputs.log }}"
          echo "${{ steps.changes.outputs.log }}" | sed 's/%0A/\n/g' | sed 's/- \([a-f0-9]*\) \(.*\)/{ "id": "\1", "message": "\2" }/' | jq -s '{commits: .}'
          echo "____________________________"
          echo "${{ toJson(steps) }}"